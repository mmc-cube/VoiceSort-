<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>æ™ºèƒ½åƒåœ¾æ¡¶æ§åˆ¶</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,sans-serif;background:#f0f2f5;color:#333;padding:12px;max-width:500px;margin:0 auto}
.header{text-align:center;padding:16px 0 8px}
.header h1{font-size:20px;font-weight:600}
.status-bar{display:flex;align-items:center;justify-content:center;gap:8px;margin:8px 0 16px;font-size:13px}
.dot{width:10px;height:10px;border-radius:50%;display:inline-block}
.dot.on{background:#52c41a}
.dot.off{background:#ff4d4f}
.card{background:#fff;border-radius:12px;padding:16px;margin-bottom:12px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
.card-title{font-size:15px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
.bin{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid #f0f0f0}
.bin:last-child{border-bottom:none}
.bin-info{display:flex;align-items:center;gap:10px}
.bin-icon{font-size:28px}
.bin-name{font-size:15px;font-weight:500}
.bin-state{font-size:12px;margin-top:2px}
.bin-state.open{color:#52c41a}
.bin-state.closed{color:#999}
.bin-cnt{font-size:13px;color:#666;min-width:50px;text-align:center}
.bin-cnt span{font-size:20px;font-weight:700;color:#333}
.bin-btns{display:flex;gap:6px}
.btn{border:none;border-radius:8px;padding:8px 14px;font-size:13px;font-weight:500;cursor:pointer;transition:opacity .2s}
.btn:active{opacity:.7}
.btn-open{background:#e6f7ff;color:#1890ff}
.btn-close{background:#fff2e8;color:#fa8c16}
.btn:disabled{background:#f5f5f5;color:#ccc;cursor:default}
.btn:disabled:active{opacity:1}
.btn-clr{background:#ff4d4f;color:#fff;width:100%;padding:12px;font-size:15px;border-radius:10px;margin-top:4px}
.alert-box{border-radius:10px;padding:12px;text-align:center;margin-bottom:12px}
.alert-box.safe{background:#f6ffed;border:1px solid #b7eb8f}
.alert-box.alarm{background:#fff1f0;border:1px solid #ffa39e}
.alert-text{font-size:15px;font-weight:600}
.alert-text.safe{color:#52c41a}
.alert-text.alarm{color:#cf1322}
.bar{height:6px;background:#f0f0f0;border-radius:3px;overflow:hidden;margin-top:4px}
.bar-fill{height:100%;border-radius:3px;transition:width .3s}
.bar-fill.safe{background:#52c41a}
.bar-fill.warn{background:#faad14}
.bar-fill.full{background:#ff4d4f}
.collapse-header{display:flex;align-items:center;justify-content:space-between;cursor:pointer;user-select:none}
.collapse-header .arrow{transition:transform .2s;font-size:12px;color:#999}
.collapse-header .arrow.open{transform:rotate(90deg)}
.log{font-size:11px;color:#999;max-height:120px;overflow-y:auto;margin-top:8px;font-family:monospace;word-break:break-all;display:none}
.log.open{display:block}
</style>
</head>
<body>

<div class="header">
  <h1>æ™ºèƒ½åƒåœ¾æ¡¶æ§åˆ¶å°</h1>
  <div class="status-bar">
    <span class="dot off" id="dotMqtt"></span>
    <span id="connText">æœªè¿æ¥</span>
  </div>
</div>

<div class="card">
  <div class="card-title">åƒåœ¾æ¡¶çŠ¶æ€</div>
  <div id="binList"></div>
</div>

<div class="alert-box safe" id="alertBox">
  <div class="alert-text safe" id="alertText">âœ“ æ‰€æœ‰åƒåœ¾æ¡¶æ­£å¸¸</div>
</div>
<div id="clrBtnWrap" style="display:none;margin-bottom:12px">
  <button class="btn btn-clr" onclick="sendCmd('CLR')">æ¸…é™¤æŠ¥è­¦ & è‡ªåŠ¨å¼€ç›–</button>
</div>

<div class="card">
  <div class="collapse-header" onclick="toggleLog()">
    <span style="font-size:15px;font-weight:600">é€šä¿¡æ—¥å¿—</span>
    <span class="arrow" id="logArrow">â–¶</span>
  </div>
  <div class="log" id="logBox"></div>
</div>

<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
const BROKER = 'ws://broker.emqx.io:8083/mqtt';
const TOPIC_UP = 'stm32/up';
const TOPIC_DOWN = 'stm32/down';
const BIN_NAMES = ['1å·æ¡¶','2å·æ¡¶','3å·æ¡¶','4å·æ¡¶'];
const MAX_CNT = 4;

let client = null;
let bins = [
  {open:0, cnt:0},
  {open:0, cnt:0},
  {open:0, cnt:0},
  {open:0, cnt:0}
];

function toggleLog(){
  const box = document.getElementById('logBox');
  const arrow = document.getElementById('logArrow');
  const isOpen = box.classList.toggle('open');
  arrow.classList.toggle('open', isOpen);
}

function initUI(){
  const list = document.getElementById('binList');
  list.innerHTML = '';
  for(let i=0;i<4;i++){
    const b = bins[i];
    const pct = Math.min(b.cnt/MAX_CNT*100,100);
    const cls = pct>=100?'full':pct>=75?'warn':'safe';
    const stCls = b.open?'open':'closed';
    const stTxt = b.open?'å·²æ‰“å¼€':'å·²å…³é—­';
    const openDis = b.open?'disabled':'';
    const closeDis = b.open?'':'disabled';
    list.innerHTML += `
    <div class="bin">
      <div class="bin-info">
        <div class="bin-icon">ğŸ—‘ï¸</div>
        <div>
          <div class="bin-name">${BIN_NAMES[i]}</div>
          <div class="bin-state ${stCls}">${stTxt}</div>
          <div class="bar"><div class="bar-fill ${cls}" style="width:${pct}%"></div></div>
        </div>
      </div>
      <div class="bin-cnt"><span>${b.cnt}</span>/${MAX_CNT}</div>
      <div class="bin-btns">
        <button class="btn btn-open" onclick="sendCmd('O${i+1}')" ${openDis}>å¼€</button>
        <button class="btn btn-close" onclick="sendCmd('C${i+1}')" ${closeDis}>å…³</button>
      </div>
    </div>`;
  }

  const alertBox = document.getElementById('alertBox');
  const alertText = document.getElementById('alertText');
  const clrWrap = document.getElementById('clrBtnWrap');
  let hasAlarm = bins.some(b=>b.cnt>=MAX_CNT);
  if(hasAlarm){
    let which = bins.findIndex(b=>b.cnt>=MAX_CNT);
    alertBox.className = 'alert-box alarm';
    alertText.className = 'alert-text alarm';
    alertText.textContent = 'âš  ' + BIN_NAMES[which] + ' å·²æ»¡ï¼è¯·æ¸…ç†';
    clrWrap.style.display = 'block';
  } else {
    alertBox.className = 'alert-box safe';
    alertText.className = 'alert-text safe';
    alertText.textContent = 'âœ“ æ‰€æœ‰åƒåœ¾æ¡¶æ­£å¸¸';
    clrWrap.style.display = 'none';
  }
}

function addLog(msg){
  const box = document.getElementById('logBox');
  const t = new Date().toLocaleTimeString();
  box.innerHTML = `<div>[${t}] ${msg}</div>` + box.innerHTML;
  if(box.children.length > 50) box.lastChild.remove();
}

function parseReport(payload){
  const m = payload.match(/^S:(\d{4}),C:(\d+),(\d+),(\d+),(\d+)$/);
  if(!m) return;
  for(let i=0;i<4;i++){
    bins[i].open = parseInt(m[1][i]);
    bins[i].cnt = parseInt(m[i+2]);
  }
  initUI();
}

function sendCmd(cmd){
  if(!client || !client.connected) return;
  client.publish(TOPIC_DOWN, cmd);
  addLog('å‘é€: ' + cmd);
}

function connect(){
  const dot = document.getElementById('dotMqtt');
  const txt = document.getElementById('connText');
  txt.textContent = 'è¿æ¥ä¸­...';

  const clientId = 'web_' + Math.random().toString(16).substr(2,8);
  client = mqtt.connect(BROKER, {clientId, clean:true, connectTimeout:5000});

  client.on('connect', function(){
    dot.className = 'dot on';
    txt.textContent = 'å·²è¿æ¥';
    client.subscribe(TOPIC_UP);
    addLog('MQTT å·²è¿æ¥ï¼Œå·²è®¢é˜… ' + TOPIC_UP);
  });

  client.on('message', function(topic, msg){
    const payload = msg.toString();
    addLog('æ”¶åˆ°: ' + payload);
    if(topic === TOPIC_UP) parseReport(payload);
  });

  client.on('close', function(){
    dot.className = 'dot off';
    txt.textContent = 'å·²æ–­å¼€ï¼Œé‡è¿ä¸­...';
  });

  client.on('error', function(err){
    addLog('é”™è¯¯: ' + err.message);
  });
}

initUI();
connect();
</script>
</body>
</html>
